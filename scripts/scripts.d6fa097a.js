"use strict";angular.module("rutasApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","uiGmapgoogle-maps"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/"})}]).config(["uiGmapGoogleMapApiProvider",function(a){a.configure({key:"AIzaSyBpMZTqGZ9tPwNjBqBBwoBenCUuQEK9yNI",v:"3.17",libraries:"weather,geometry,visualization"})}]),angular.module("rutasApp").directive("resize",["$window",function(a){return function(b,c){var d=angular.element(a);b.getWindowDimensions=function(){return{h:d.height(),w:d.width()}},b.$watch(b.getWindowDimensions,function(a,c){b.windowHeight=a.h,b.windowWidth=a.w,b.style=function(){return{height:a.h-angular.element("header")[0].offsetHeight+"px"}}},!0),d.bind("resize",function(){b.$apply()})}}]),angular.module("rutasApp").directive("navButtons",function(){return{restrict:"E",templateUrl:"views/nav-buttons.html"}}),angular.module("rutasApp").controller("MainCtrl",["$scope","$rootScope","uiGmapGoogleMapApi","$http","RateService","$window","$modal","$log","$q","uiGmapIsReady",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b=i.defer();return d.get("rutas/rutas_todas.json").success(function(c){var d,e,f=[];angular.forEach(c,function(b,c){angular.forEach(b,function(b,c){d=new google.maps.Polyline({path:b}),Math.round(r(d,a))<=500&&(c!=e&&f.push(c),e=c)})}),f?b.resolve(f):b.reject(console.log("error en analyzer"))}).error(function(a){console.log("error")}),b.promise}function l(c){b.$broadcast("send-routes",{routes:[],numRoutes:0,buttonAllRoutes:a.buttonAllRoutes,marker:a.marker,markerPlace:a.markerPlace})}function m(a,b){var c=b*Math.PI/180,d=n(a*Math.PI/180),e=Math.cos(d);this.x=e*Math.cos(c),this.y=e*Math.sin(c),this.z=Math.sin(d)}function n(a){var b=1/298.257223563,c=(1-b)*(1-b);return Math.atan(Math.tan(a)*c)}function o(a){var b=1/298.257223563,c=(1-b)*(1-b);return Math.atan(Math.tan(a)/c)}function p(a,b,c,d){var e=a.crossNormalize(b),f=c.crossNormalize(d);return e.crossNormalize(f)}function q(a){return 6378137*a}function r(a,b){var c,d=999999999,e=new m(b.lat(),b.lng());for(c=0;c<a.getPath().getLength()-1;c++){var f=a.getPath().getAt(c),g=new m(f.lat(),f.lng()),h=a.getPath().getAt(c+1),i=new m(h.lat(),h.lng()),j=e.distanceToLineSegMtrs(g,i);d>j&&(d=j)}return d}a.rutas=[{id:"01",name:"Ruta 01"},{id:"02",name:"Ruta 02"},{id:"03",name:"Ruta 03"},{id:"04",name:"Ruta 04"},{id:"05",name:"Ruta 05"},{id:"06",name:"Ruta 06"},{id:"07",name:"Ruta 07"},{id:"08",name:"Ruta 08"},{id:"09",name:"Ruta 09"},{id:"10",name:"Ruta 10"},{id:"11",name:"Ruta 11"},{id:"12",name:"Ruta 12"},{id:"14",name:"Ruta 14"},{id:"15",name:"Ruta 15"},{id:"16",name:"Ruta 16"},{id:"18",name:"Ruta 18"},{id:"19",name:"Ruta 19"},{id:"20",name:"Ruta 20"},{id:"21",name:"Ruta 21"},{id:"23",name:"Ruta 23"},{id:"23B",name:"Ruta 23B"},{id:"24",name:"Ruta 24"},{id:"25",name:"Ruta 25"},{id:"27",name:"Ruta 27"},{id:"28",name:"Ruta 28"},{id:"29",name:"Ruta 29"},{id:"30",name:"Ruta 30"},{id:"31",name:"Ruta 31"},{id:"33",name:"Ruta 33"},{id:"34",name:"Ruta 34"},{id:"35",name:"Ruta 35"},{id:"36",name:"Ruta 36"},{id:"37",name:"Ruta 37"},{id:"38",name:"Ruta 38"},{id:"39",name:"Ruta 39"},{id:"40",name:"Ruta 40"},{id:"41",name:"Ruta 41"},{id:"42",name:"Ruta 42"},{id:"43",name:"Ruta 43"},{id:"44",name:"Ruta 44"},{id:"45",name:"Ruta 45"},{id:"46",name:"Ruta 46"},{id:"47",name:"Ruta 47"},{id:"48",name:"Ruta 48"},{id:"50",name:"Ruta 50"}],a.colorRutas=[{ida:"#2ECCFA",regreso:"#FF8000"},{ida:"#0040FF",regreso:"#DF0101"},{ida:"#6A0888",regreso:"#F0ED3B"},{ida:"#B404AE",regreso:"#51D15E"}],a.map={center:{latitude:21.882886,longitude:-102.294878},zoom:13};var s;a.mapReady=!1,a.activatedRoutes=[];var t=-1;a.buspoints=[],a.places=[],a.markerClick=[],j.promise(1).then(function(b){b.forEach(function(a){s=a.map}),a.mapReady=!0}),a.resultAutocomplete="",a.optionsAutocomplete={country:"MX"},a.detailsAutocomplete="",a.analytics=function(a,b,c){ga("send","event",a,b,c)},a.home=function(){f.location.reload()},a.messageLocation="Mi ubicación",a.userLocation=function(){a.messageLocation="Localizando",navigator.geolocation.getCurrentPosition(function(b){var c=a.getLocation(b);Parse.initialize("Z6EWUM9VVRIe5JX3Iw2ZnLB1j2LQn9J0CU0DFXT4","cfs3GctSfGPGANhGS02dqS6JflMBl1WlebkmXcUw");var d=Parse.Object.extend("UserLocation"),e=new d;e.save({ubicacion:c.A+","+c.F},{success:function(a){},error:function(a,b){console.log("Error al enviar cordenadas")}})},function(a){swal({title:"Lo sentimos, no es posible encontrar tú ubicación en este momento.",timer:3e3,showConfirmButton:!1})})},a.getLocation=function(b){var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);return a.$apply(function(){a.marker&&a.marker.setMap(null);var b="images/marker2.png";a.marker=new google.maps.Marker({position:c,map:s,title:"Mi Ubicación",icon:b}),s.setCenter(c),a.messageLocation="Mi ubicación"}),c},a.clearCoords=function(){a.markerClick.position=null,a.routes=null,a.tempoPlaceName=null},a.clearMarkers=function(b){a.marker&&a.marker.setMap(b),a.markerPlace&&a.markerPlace.setMap(b);for(var c=0;c<a.markerClick.length;c++)a.markerClick[c].setMap(b);a.markers={}},a.clearPolylines=function(b){a.polylines=[],t=-1,a.markers={}},a.cleanMap=function(){angular.element(".activeRoute").removeClass("activeRoute"),a.clearPolylines(),a.clearMarkers(),a.routes=null,a.tempoPlaceName=null},a.selectedRoute=function(a){angular.element("#"+a).addClass("activeRoute")},a.getRoute=function(b){a.markers={},a.windowOptions={visible:!1},a.windowOptions2={visible:!1},d.get("rutas/"+b+"_ida.json").success(function(d){c.then(function(c){d.stroke.color=a.colorRutas[t].ida,d.icons[0].icon={path:c.SymbolPath.FORWARD_OPEN_ARROW},a.polylines.push(d),a.markers.push={id:b,coords:{latitude:d.path[0].latitude,longitude:d.path[0].longitude}},angular.forEach(d.buspoints,function(b,c){var d={id:b.id,icon:{url:b.image.url,size:new google.maps.Size(32,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,32)},coords:{latitude:b.latitude,longitude:b.longitude}};a.buspoints.push(d)})})}).error(function(a){console.err(a)}),d.get("rutas/"+b+"_regreso.json").success(function(d){c.then(function(c){d.stroke.color=a.colorRutas[t].regreso,d.icons[0].icon={path:c.SymbolPath.FORWARD_OPEN_ARROW},a.polylines.push(d),a.markers.push={id:b,coords:{latitude:d.path[0].latitude,longitude:d.path[0].longitude}}})}).error(function(a){console.err(a)}),t++,t>3&&(t=0)},a.getAllRoutes=function(b){a.markers={},a.windowOptions={visible:!1},a.windowOptions2={visible:!1};for(var e=0,f=0,g=0;g<b.length;g++)d.get("/rutas/"+b[g]+"_ida.json").success(function(d){c.then(function(c){d.stroke.color=a.colorRutas[e].ida,d.icons[0].icon={path:c.SymbolPath.FORWARD_OPEN_ARROW},a.polylines.push(d),a.markers.push={id:b[g],coords:{latitude:d.path[0].latitude,longitude:d.path[0].longitude}},angular.forEach(d.buspoints,function(b,c){var d={id:b.id,icon:{url:b.image.url,size:new google.maps.Size(32,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,32)},coords:{latitude:b.latitude,longitude:b.longitude}};a.buspoints.push(d)})}),e++,e>3&&(e=0)}).error(function(a){console.err(a)}),d.get("/rutas/"+b[g]+"_regreso.json").success(function(d){c.then(function(c){d.stroke.color=a.colorRutas[f].regreso,d.icons[0].icon={path:c.SymbolPath.FORWARD_OPEN_ARROW},a.polylines.push(d),a.markers.push={id:b[g],coords:{latitude:d.path[0].latitude,longitude:d.path[0].longitude}}}),f++,f>3&&(f=0)}).error(function(a){console.err(a)})},a.getBestRoutesBySearchBox=function(b){if(b){var c=b.geometry.location,d=b.name,e={url:b.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(40,40)};a.showCloseRoutesToLocation(c),a.markerPlace&&a.markerPlace.setMap(null),a.markerPlace=new google.maps.Marker({position:c,map:s,title:d,icon:e}),s.setCenter(c),a.clearCoords()}},a.findCloseRoutes=function(c,d){a.routes=c,a.tempoPlaceName=d,a.numRoutes=c.length,a.buttonAllRoutes=!0,0==a.numRoutes?a.buttonAllRoutes=!1:a.numRoutes<=4?a.numRoutes=1:a.numRoutes>4&&a.numRoutes<=8?(a.numRoutes=2,a.buttonAllRoutes=!1):a.numRoutes>8&&a.numRoutes<=15?(a.numRoutes=3,a.buttonAllRoutes=!1):(a.numRoutes=4,a.buttonAllRoutes=!1),b.$broadcast("send-routes",{routes:a.routes,numRoutes:a.numRoutes,buttonAllRoutes:a.buttonAllRoutes,marker:a.marker,markerPlace:a.markerPlace})},a.showCloseRoutesToLocation=function(b){var c;c=b?a.getCloseRoutesToLocation(b):a.getCloseRoutesToLocation(),c.then(function(b){a.findCloseRoutes(b,"Rutas encontradas")},function(a){console.log(a)})},a.getCloseRoutesToLocation=function(b){var c,d,e=i.defer();return b?(c=b,d=k(c),d?e.resolve(d):e.reject("error")):navigator.geolocation.getCurrentPosition(function(b){c=a.getLocation(b),d=k(c),d?e.resolve(d):e.reject("error")},function(a){console.log("Error")}),e.promise},a.getBestRoutes=function(b,c){if(c)var d=k(c);else var d=a.getCloseRoutesToLocation();var e=k(b),f=[];d.then(function(b){e.then(function(c){angular.forEach(b,function(a,b){angular.forEach(c,function(b,c){a==b&&f.push(a)})});var d;f.length>0?(d=f,a.findCloseRoutes(f,"Rutas desde tu ubicación al destino seleccionado")):(d="<h3>Lo sentimos, no hay rutas cercanas que te lleven a tu destino</h3>",d&&l(d),a.cleanMap())},function(a){console.log("error destino "+a)})},function(a){console.log("error origen "+a)})},m.prototype=new m,m.prototype.getLatitudeRadians=function(){return o(Math.atan2(this.z,Math.sqrt(this.x*this.x+this.y*this.y)))},m.prototype.getLongitudeRadians=function(){return Math.atan2(this.y,this.x)},m.prototype.getLatitude=function(){return 180*this.getLatitudeRadians()/Math.PI},m.prototype.getLongitude=function(){return 180*this.getLongitudeRadians()/Math.PI},m.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},m.prototype.crossLength=function(a){var b=this.y*a.z-this.z*a.y,c=this.z*a.x-this.x*a.z,d=this.x*a.y-this.y*a.x;return Math.sqrt(b*b+c*c+d*d)},m.prototype.scale=function(a){var b=new m(0,0);return b.x=this.x*a,b.y=this.y*a,b.z=this.z*a,b},m.prototype.crossNormalize=function(a){var b=this.y*a.z-this.z*a.y,c=this.z*a.x-this.x*a.z,d=this.x*a.y-this.y*a.x,e=Math.sqrt(b*b+c*c+d*d),f=new m(0,0);return f.x=b/e,f.y=c/e,f.z=d/e,f},m.prototype.antipode=function(){return this.scale(-1)},m.prototype.distance=function(a){return Math.atan2(a.crossLength(this),a.dot(this))},m.prototype.distanceToLineSegMtrs=function(a,b){var c=a.crossNormalize(b),d=p(a,b,this,c),e=a.distance(b),f=a.distance(d),g=b.distance(d);return e>=f&&e>=g?q(this.distance(d)):(d=d.antipode(),f=a.distance(d),g=b.distance(d),q(e>=f&&e>=g?this.distance(d):Math.min(a.distance(this),b.distance(this))))},a.onRouteClick=function(){a.windowOptions.visible=!a.windowOptions.visible},a.closeRouteClick=function(){a.windowOptions.visible=!1},a.onBusClick=function(b,c){a.closeBusClick(),a.windowOptions2.visible=!a.windowOptions2.visible,a.stopCoords=c,a.buspoint=b,console.log("Bus opened"),console.log(c),console.log(b)},a.closeBusClick=function(){a.windowOptions2.visible=!1,a.stopCoords={latitude:21.882886,longitude:-102.294878},a.buspoint=null,console.log("Bus closed")},c.then(function(b){a.polylines=[{id:7,path:[{latitude:21.971862,longitude:-102.345039}],stroke:{color:"#CC0000",weight:3},editable:!1,draggable:!1,geodesic:!0,visible:!0,icons:[{icon:{path:b.SymbolPath.BACKWARD_OPEN_ARROW},offset:"25px",repeat:"50px"}]}]}),a.searchModal=function(){var b=g.open({templateUrl:"views/search.html",controller:"SearchModalInstanceCtrl",scope:a,resolve:{marker:function(){return a.marker},markerPlace:function(){return a.markerPlace}},size:"sm"});b.result.then(function(b){b?a.getRoute(b):a.getAllRoutes(a.routes)},function(){h.info("Modal dismissed at: "+new Date)})},a.$on("send-routes",function(b,c){a.routes=c.routes,a.numRoutes=c.numRoutes,a.buttonAllRoutes=c.buttonAllRoutes,a.marker=c.marker,a.markerPlace=c.markerPlace}),a.activeTwoPoints=!1,a.clickMarker=function(){google.maps.event.addListener(s,"click",function(b){a.activeTwoPoints||a.cleanMap();var c=new google.maps.LatLng(b.latLng.lat(),b.latLng.lng()),d="images/marker1.png",e=new google.maps.Marker({position:c,map:s,title:"Nuevo destino",icon:d});a.markerClick.push(e),a.showOptionsClick()})},a.showOptionsClick=function(){if(a.activeTwoPoints)var b=g.open({templateUrl:"views/searchByTwoPoints.html",controller:"SearchByPointModalInstanceCtrl",scope:a,resolve:{clickMarker:function(){return a.markerClick}},size:"sm"});else var b=g.open({templateUrl:"views/seachByPoint.html",controller:"SearchByPointModalInstanceCtrl",scope:a,resolve:{clickMarker:function(){return a.markerClick}},size:"sm"});b.result.then(function(b){1==b.index?a.routesByPoint(b.markerClick):2==b.index?a.routesByPointAndLocation(b.markerClick):3==b.index?(a.activeTwoPoints=!0,a.alertRoutesByPoint()):a.routesByPointToPoint(b.markerClick)},function(){a.activeTwoPoints=!1,a.cleanMap(),h.info("Modal dismissed at: "+new Date)})},a.routesByPoint=function(b){var c=b.length,d=b[c-1].position;a.showCloseRoutesToLocation(d),a.clearCoords(),a.searchModal()},a.routesByPointAndLocation=function(b){var c=b.length,d=b[c-1].position;a.getBestRoutes(d),a.clearCoords(),a.searchModal()},a.routesByPointToPoint=function(b){a.activeTwoPoints=!0;var c=b.length,d=b[c-1].position;if(b[c-2])var e=b[c-2].position;a.getBestRoutes(d,e),a.searchModal(),a.activeTwoPoints=!1},a.alertRoutesByPoint=function(){swal({title:"Selecciona un punto en el mapa...",timer:1e3,showConfirmButton:!1})}}]),angular.module("rutasApp").controller("UserLocationCtrl",["$scope","uiGmapGoogleMapApi",function(a,b){}]),angular.module("rutasApp").controller("CommentsCtrl",["$scope","$modal","$log",function(a,b,c){a.comment=[],Parse.initialize("Z6EWUM9VVRIe5JX3Iw2ZnLB1j2LQn9J0CU0DFXT4","cfs3GctSfGPGANhGS02dqS6JflMBl1WlebkmXcUw"),a.saveComment=function(){var c=Parse.Object.extend("Contact"),d=new c;d.save({name:a.comment.Name,email:a.comment.email,phone:a.comment.phone,category:a.comment.category,comment:a.comment.comment},{success:function(a){console.log("Enviado correctamente");b.open({template:'<div class="modal-body text-center"><alert ng-model="message" type="{{alert}}" close="closeAlert()">{{message}}</alert></div>',controller:"MessageInstanceCtrl",size:null,resolve:{msg:function(){return"Solicitud enviada correctamente"},alert:function(){return"success"}}})},error:function(a,c){console.log("Error al enviar");b.open({template:'<div class="modal-body text-center"><alert ng-model="message" type="{{alert}}" close="closeAlert()">{{message}}</alert></div>',controller:"MessageInstanceCtrl",size:null,resolve:{msg:function(){return"Error: la solicitud no se pudo enviar"},alert:function(){return"danger"}}})}})},a.doComment=function(){var a=b.open({templateUrl:"views/contact.html",controller:"ModalInstanceCtrl",size:null});a.result.then(function(a){},function(){c.info("Modal dismissed at: "+new Date)})}}]).controller("ModalInstanceCtrl",["$scope","$modalInstance",function(a,b){a.ok=function(){b.close(a.comment)},a.cancel=function(){b.dismiss("cancel")}}]).controller("MessageInstanceCtrl",["$scope","$modalInstance","msg","alert",function(a,b,c,d){a.message=c,a.alert=d,a.closeAlert=function(){b.close()}}]),angular.module("rutasApp").controller("SearchModalInstanceCtrl",["$scope","$rootScope","$modalInstance","marker","markerPlace",function(a,b,c,d,e){a.ok=function(a){c.close(a)},a.cancel=function(){c.dismiss("cancel")},a.cleanSearch=function(){b.$broadcast("send-routes",{routes:null,numRoutes:1,buttonAllRoutes:!1,marker:a.marker,markerPlace:a.markerPlace}),a.cleanMap()}}]).controller("SearchByPointModalInstanceCtrl",["$scope","$modalInstance","clickMarker",function(a,b,c){a.markerClick=c,a.okPoint=function(c){b.close({markerClick:a.markerClick,index:c})},a.cancelPoint=function(){b.dismiss("cancel")}}]),angular.module("rutasApp").service("RateService",["$timeout","$modal","$log",function(a,b,c){function d(){e()}function e(){var d=b.open({templateUrl:"views/rate-this-app.html",controller:"ModalRatingCtrl",size:null});d.result.then(function(){a.cancel(f)},function(){c.info("Modal dismissed at: "+new Date),a.cancel(f)})}if(!localStorage.rateDone)var f=a(d,18e4)}]).controller("ModalRatingCtrl",["$scope","$modalInstance","$modal",function(a,b,c){Parse.initialize("Z6EWUM9VVRIe5JX3Iw2ZnLB1j2LQn9J0CU0DFXT4","cfs3GctSfGPGANhGS02dqS6JflMBl1WlebkmXcUw"),a.rate={},a.max=5,a.hoveringOver=function(b){a.overStar=b,a.percent=100*(b/a.max)},a.saveRate=function(){var b=Parse.Object.extend("Rate"),c=new b;c.save({email:a.rate.email,comment:a.rate.comment,stars:a.rate.stars},{success:function(a){localStorage.rateDone=!0},error:function(a,b){}}),a.doRate()},a.doRate=function(){b.close()},a.cancelRate=function(){b.dismiss("cancel")}}]),angular.module("rutasApp").directive("ngAutocomplete",["$parse",function(a){return{scope:{details:"=",ngAutocomplete:"=",options:"="},link:function(a,b,c,d){var e,f=function(){e={},a.options&&(a.options.types&&(e.types=[],e.types.push(a.options.types)),a.options.bounds&&(e.bounds=a.options.bounds),a.options.country&&(e.componentRestrictions={country:a.options.country}))};f();var g=function(){a.gPlace=new google.maps.places.Autocomplete(b[0],e),google.maps.event.addListener(a.gPlace,"place_changed",function(){a.$apply(function(){a.details=a.gPlace.getPlace(),a.ngAutocomplete=b.val()})})};g(),a.watchOptions=function(){return a.options},a.$watch(a.watchOptions,function(){f(),g(),b[0].value="",a.ngAutocomplete=b.val()},!0)}}}]);